!function(){function e(){var e=(new Date).getTime();window.performance&&"function"==typeof window.performance.now&&(e+=window.performance.now());var t="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var i=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"===t?i:3&i|8).toString(16)});return t}function t(){c=!1,window.currentTask=!1,$(".sweet-alert").is(".visible")&&window.swal.close(),u={valid:!1},history.state&&history.state.valid?history.pushState(u,p,"/"):history.replaceState(u,p,"/"),document.title=p,$("#query").removeClass("hidden"),$("#video-info").addClass("hidden"),$("#loading-holder").addClass("hidden"),$("#uri").val("").focus(),$("#uri").closest(".mdl-textfield").get(0).MaterialTextfield.boundUpdateClassesHandler()}function i(){if(!u.loaded)return null;if(u.list.length>1&&u.list.length>=u.page){var e=u.title+"("+u.page+")";return u.list[u.page-1].part.length&&(e+=" - "+u.list[u.page-1].part),e}return u.title}function a(e){c=!1,window.swal({title:"视频信息读取失败",text:"错误信息: "+e,type:"error",showCancelButton:!0,confirmButtonText:"返回",cancelButtonText:"重试"},function(e){e?history.length>2?history.back():t():r()})}function o(){var e=i(),t=e?e+" - av"+u.avid+"p"+u.page+" - "+p:"av"+u.avid+"p"+u.page+" - "+p;!history.state||history.state&&history.state.avid===u.avid&&history.state.page===u.page?history.replaceState(u,t,"/"+u.avid+"/"+u.page):history.pushState(u,t,"/"+u.avid+"/"+u.page),document.title=t,e&&l()}function r(){if(c)return!1;window.currentTask=!1,$(".sweet-alert").is(".visible")&&window.swal.close(),o();var e=localStorage.getItem(u.avid+"/"+u.page);if(e)try{e=JSON.parse(window.LZString.decompress(e)),parseInt((new Date).getTime()/1e3)-e.ts<86400&&(u=e)}catch(t){window.console.error("Failed to read cache.",t),localStorage.removeItem(u.avid+"/"+u.page)}return u.loaded?(o(),!1):(c=!0,$("#query").addClass("hidden"),$("#video-info").addClass("hidden"),$("#loading-holder").removeClass("hidden"),void $.getJSON("http://api.bilibili.com/view?type=jsonp&appkey=95acd7f6cc3392f3&id="+u.avid+"&page="+u.page+"&batch=true&callback=?",function(e){return c?(c=!1,void(e.error?a(e.code+" ("+e.error+")"):(u=$.extend(u,{title:e.title,desc:e.description,cover:e.pic,type:e.typename,tags:e.tag.split(","),list:e.list,author:e.author,date:e.created_at,play:e.play,favorites:e.favorites,loaded:!0}),localStorage.setItem(u.avid+"/"+u.page,window.LZString.compress(JSON.stringify($.extend(u,{ts:parseInt((new Date).getTime()/1e3)})))),o()))):!1}).error(function(e){a(e.status+" ("+e.statusText+")")}))}function n(){if($("#uri").val().length&&$("#uri").get(0).validity.valid){var e=/\/video\/av([0-9]+)\/(index_([0-9]+)\.html)?(\?.*)?$/.exec($("#uri").val());u={avid:parseInt(e[1]),page:parseInt(e[3]),valid:!0},u.page=u.page>0&&isFinite(u.page)?u.page:1,r()}}function d(e){return e!==window.currentTask?!1:(window.currentTask=!1,$("#audio-info .center").addClass("hidden"),$("#audio-info .button-group").removeClass("hidden"),$("#audio-info .loading").removeClass("active"),$("#download-btn").off("click").click(function(){window.open(u.audio.url)}).find(".download").text("下载 "+u.audio.format+" 音频 (比特率: "+u.audio.quality+" kbit/s)"),void $("#reload-btn").prop("disabled",parseInt((new Date).getTime()/1e3)-parseInt(u.audio.time)<153600))}function s(e){if(e!==window.currentTask)return!1;var t=u.avid,i=u.page,a=1e3;return u.audio?(d(e),!1):($("#audio-info .loading").addClass("active"),$("#audio-info .center").removeClass("hidden"),$("#audio-info .button-group").addClass("hidden"),void $.ajax("http://bilibili.audio/get.php",{method:"GET",dataType:"json",timeout:a,data:{aid:t,p:i}}).done(function(a){switch($("#audio-info .center .mdl-progress").get(0).MaterialProgress&&($("#audio-info .center .mdl-progress").removeClass("mdl-progress__indeterminate"),$("#audio-info .center .mdl-progress").get(0).MaterialProgress.setProgress(0),$("#audio-info .center .mdl-progress").addClass("mdl-progress__indeterminate")),$("#audio-info .center p").text("根据服务器负载, 这可能需要一段时间..."),parseInt(a.process)){case 0:$("#audio-info .center h3").text("正在等待队列"),$("#audio-info .center p").text("在当前转换任务之前有 "+a.tasks+" 个任务");break;case 1:$("#audio-info .center h3").text("正在解析视频信息");break;case 2:$("#audio-info .center h3").text("正在获取视频信息");break;case 3:a.progress=a.progress?parseFloat(a.progress):0,a.progress>100&&(a.progress=100),$("#audio-info .center h3").text("正在下载视频文件"),$("#audio-info .center p").text("音频格式: "+a.format+" ("+a.quality+" kbit/s) 当前进度: "+a.progress+"%"),$("#audio-info .center .mdl-progress").get(0).MaterialProgress&&($("#audio-info .center .mdl-progress").removeClass("mdl-progress__indeterminate"),$("#audio-info .center .mdl-progress").get(0).MaterialProgress.setProgress(a.progress));break;case 4:$("#audio-info .center h3").text("正在保存音频文件"),$("#audio-info .center p").text("音频格式: "+a.format+" ("+a.quality+" kbit/s)");break;case 5:if(parseInt(a.status)){u.audio=a,localStorage.setItem(u.avid+"/"+u.page,window.LZString.compress(JSON.stringify(u))),d(e);break}$("#audio-info .center h3").text("发生异常错误");break;default:window.console.error("Failed to get audio info for task "+window.currentTask+" (av"+t+"p"+i+")!"),window.setTimeout(function(){s(e)},1e3)}var o=function(){return e!==window.currentTask?!1:void window.swal({title:"音频文件提取/转换失败",text:"点击「重试」重新提交任务",type:"error",showCancelButton:!0,confirmButtonText:"重试",cancelButtonText:"取消"},function(a){return a?void $.ajax("http://bilibili.audio/get.php?aid="+t+"&p="+i,{method:"POST",dataType:"json",timeout:2e3,data:{retry:1}}).always(function(){s(e)}):!1})},r=function(){return n&&e===window.currentTask?(window.swal({title:"音频文件提取/转换失败",text:"请等待 "+(120+parseInt(a.time)-parseInt((new Date).getTime()/1e3))+" 秒后重试...",type:"error",showCancelButton:!0,showConfirmButton:!1,cancelButtonText:"取消"},function(){n=!1}),void(parseInt((new Date).getTime()/1e3)-parseInt(a.time)<=120?setTimeout(function(){r()},1e3):o())):!1},n=!1;-1===parseInt(a.status)?($("#audio-info .center h3").text("任务提交失败"),$("#audio-info .center p").text("bilibili.audio 目前仅支持 10 分钟以内视频的转换"),window.swal({title:"任务提交失败",text:"bilibili.audio 目前仅支持 10 分钟以内视频的转换. 对于其它内容, 您可以尝试下载视频文件后手动转换.",type:"error",confirmButtonText:"下载视频"},function(e){window.open("http://www.bilibili.download/video/av"+u.avid+"/index_"+u.page+".html")})):0===parseInt(a.status)&&(parseInt(a.process)<3||5===parseInt(a.process)||10===parseInt(a.retry))?parseInt((new Date).getTime()/1e3)-parseInt(a.time)>120?o():(n=!0,r()):5!==parseInt(a.process)&&setTimeout(function(){s(e)},500)}).error(function(t,i){"timeout"===i?(5e3>a&&(a+=500),s(e)):window.setTimeout(function(){s(e)},1e3)}))}function l(){$("#video-info").removeClass("hidden"),$("#query").addClass("hidden"),$("#loading-holder").addClass("hidden"),$("#video-info .cover").css("background-image","url("+u.cover+")"),$("#video-info .title").text(i()),$("#video-info .author").text(u.author),$("#video-info .type").text(u.type),$("#video-info .date").text(u.date),$("#video-info .play").text(u.play),$("#video-info .favorites").text(u.favorites),$("#video-info .desc").text(u.desc),$("#video-info .tags").empty();for(var t in u.tags)$("#video-info .tags").append($('<span class="tag">').text(u.tags[t]).prop("outerHTML")+" ");if($("#part-dropdown .mdl-menu__container").remove(),u.list.length>1){$("#part-dropdown").removeClass("hidden");var a=$('<ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="part-btn"></ul>'),o=function(){$(this).data("page")!==u.page&&(u={avid:u.avid,page:$(this).data("page"),valid:!0},r())};for(var t in u.list){var n=parseInt(t)+1+"、"+(u.list[t].part.length?u.list[t].part:"分段"+(parseInt(t)+1)),d=$('<li class="mdl-menu__item"></li>').text(n).click(o).data("page",parseInt(t)+1);parseInt(t)+1===u.page&&d.attr("disabled",!0),a.append(d)}$("#part-dropdown").append(a),window.componentHandler.upgradeElements(a.toArray())}else $("#part-dropdown").addClass("hidden");u.ts?$("#refresh-btn").removeClass("hidden"):$("#refresh-btn").addClass("hidden"),window.currentTask=e(),s(window.currentTask),$("#audio-info .center .mdl-progress").get(0).MaterialProgress&&($("#audio-info .center .mdl-progress").removeClass("mdl-progress__indeterminate"),$("#audio-info .center .mdl-progress").get(0).MaterialProgress.setProgress(0),$("#audio-info .center .mdl-progress").addClass("mdl-progress__indeterminate")),$("#audio-info .center h3").text("正在提交任务"),$("#audio-info .center p").text("根据服务器负载, 这可能需要一段时间...")}var p="哔哩哔哩音频 - bilibili.audio",u={},c=!1;if(u.param=location.pathname.slice(1).split("/"),/^\/video\/av([0-9]+)\/(index_([0-9]+)\.html)?(\?.*)?$/.test(location.pathname)){var g=/^\/video\/av([0-9]+)\/(index_([0-9]+)\.html)?(\?.*)?$/.exec(location.pathname);u.avid=parseInt(g[1]),u.page=parseInt(g[3]),u.page=u.page>0&&isFinite(u.page)?u.page:1,u.valid=!0}else 2!==u.param.length?u.valid=!1:(u.avid=parseInt(u.param[0]),u.page=parseInt(u.param[1]),isNaN(u.avid)||isNaN(u.page)||!isFinite(u.avid)||!isFinite(u.page)?u.valid=!1:u.valid=!0);window.addEventListener("popstate",function(e){u=e.state,document.title=u.loaded?document.title=i()+" - av"+u.avid+"p"+u.page+" - "+p:p,u.valid?r():t()}),$(document).ready(function(){u.valid?r():$("#query").on("mdl-componentupgraded",function(){setTimeout(function(){t()},0),$("#query").off("mdl-componentupgraded")}),$("#uri").on("paste",n).keyup(n),$(".mdl-layout-title").click(function(){t()}),$("#video-info .cover .play_hover i").click(function(){window.open("http://www.bilibili.com/av"+u.avid+"/index_"+u.page+".html")}),$("#refresh-btn").click(function(){return u.valid?(localStorage.removeItem(u.avid+"/"+u.page),u={avid:u.avid,page:u.page,valid:!0},void r()):!1}),$("#reload-btn").click(function(){return $(this).prop("disabled")?!1:void window.swal({title:"刷新服务器端存储",text:"刷新服务器端存储将导致原音频内容再新的转换任务完成前不可下载, 请仅在改分段视频内容变更的时候使用该功能. 如果只是增加了新的分段, 您只需通过页面右上角的刷新按钮刷新本地缓存即可. 滥用此功能将会导致您被 bilibili.audio 禁止使用. 确认要继续吗?",type:"warning",showCancelButton:!0,confirmButtonText:"确认",cancelButtonText:"取消"},function(t){t&&($("#audio-info .center .mdl-progress").get(0).MaterialProgress&&($("#audio-info .center .mdl-progress").removeClass("mdl-progress__indeterminate"),$("#audio-info .center .mdl-progress").get(0).MaterialProgress.setProgress(0),$("#audio-info .center .mdl-progress").addClass("mdl-progress__indeterminate")),$("#audio-info .center h3").text("正在提交任务"),$("#audio-info .center p").text("根据服务器负载, 这可能需要一段时间..."),$.ajax("http://bilibili.audio/get.php?aid="+u.avid+"&p="+u.page,{method:"POST",dataType:"json",timeout:2e3,data:{retry:1}}).always(function(){$("#audio-info .center .mdl-progress").get(0).MaterialProgress&&($("#audio-info .center .mdl-progress").removeClass("mdl-progress__indeterminate"),$("#audio-info .center .mdl-progress").get(0).MaterialProgress.setProgress(0),$("#audio-info .center .mdl-progress").addClass("mdl-progress__indeterminate")),delete u.audio,localStorage.setItem(u.avid+"/"+u.page,window.LZString.compress(JSON.stringify(u))),$("#audio-info .center h3").text("正在提交任务"),$("#audio-info .center p").text("根据服务器负载, 这可能需要一段时间..."),window.currentTask=e(),s(window.currentTask)}))})}),$("#search").keyup(function(e){if(13===e.keyCode){var i=$(this).blur().val().match(/av([0-9]+)(\/)?(index_([0-9]+)\.html)?(\?.*)?$/i);$(this).val("").closest(".mdl-textfield").get(0).MaterialTextfield.boundUpdateClassesHandler(),i?(u.page=u.page>0&&isFinite(u.page)?u.page:1,r()):t()}})})}();