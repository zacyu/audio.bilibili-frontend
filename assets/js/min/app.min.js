function showQueryPage(){videoInfo={valid:!1},history.state.valid?history.pushState(videoInfo,title,"/"):history.replaceState(videoInfo,title,"/"),$("#query").removeClass("hidden"),$("#loading-holder").addClass("hidden")}function loadVideoInfoErrorHandler(e){ajaxBusy=!1,window.swal({title:"视频信息读取失败",text:"错误信息: "+e,type:"error",showCancelButton:!0,confirmButtonText:"返回",cancelButtonText:"重试"},function(e){e?history.length>2?history.back():showQueryPage():loadVideoInfo()})}function loadVideoInfo(){return ajaxBusy?!1:videoInfo.loaded?(renderVideoPage(),!1):(ajaxBusy=!0,$("#query").addClass("hidden"),$("#loading-holder").removeClass("hidden"),void $.getJSON("http://api.bilibili.com/view?type=jsonp&appkey=95acd7f6cc3392f3&id="+videoInfo.avid+"&page="+videoInfo.page+"&batch=true&callback=?",function(e){e.error?loadVideoInfoErrorHandler(e.code+" ("+e.error+")"):(videoInfo=$.extend(videoInfo,{title:e.title,desc:e.description,cover:e.pic,type:e.typename,tags:e.tag.split(","),list:e.list,author:e.author,time:e.created_at,play:e.play,favorites:e.favorites,loaded:!0}),document.title=videoInfo.title+" - av"+videoInfo.avid+"p"+videoInfo.page+" - "+title,history.state.avid===videoInfo.avid&&history.state.page===videoInfo.page?history.replaceState(videoInfo,document.title,"/"+videoInfo.avid+"/"+videoInfo.page):history.pushState(videoInfo,document.title,"/"+videoInfo.avid+"/"+videoInfo.page))}).error(function(e){loadVideoInfoErrorHandler(e.status+" ("+e.statusText+")")}))}function checkURI(){if($("#uri").val().length&&$("#uri").get(0).validity.valid){var e=/\/video\/av([0-9]+)\/(index_([0-9]+)\.html)?(\?.*)?$/.exec($("#uri").val());videoInfo={avid:parseInt(e[1]),page:parseInt(e[3])},videoInfo.page=videoInfo.page>0&&isFinite(videoInfo.page)?videoInfo.page:1,videoInfo.valid=!0,loadVideoInfo()}}function renderVideoPage(){}var title="哔哩哔哩音频 - bilibili.audio",videoInfo={},ajaxBusy=!1;if(videoInfo.param=location.pathname.slice(1).split("/"),/^\/video\/av([0-9]+)\/(index_([0-9]+)\.html)?(\?.*)?$/.test(location.pathname)){var matches=/^\/video\/av([0-9]+)\/(index_([0-9]+)\.html)?(\?.*)?$/.exec(location.pathname);videoInfo.avid=parseInt(matches[1]),videoInfo.page=parseInt(matches[3]),videoInfo.page=videoInfo.page>0&&isFinite(videoInfo.page)?videoInfo.page:1,videoInfo.valid=!0}else 2!==videoInfo.param.length?videoInfo.valid=!1:(videoInfo.avid=parseInt(videoInfo.param[0]),videoInfo.page=parseInt(videoInfo.param[1]),isNaN(videoInfo.avid)||isNaN(videoInfo.page)||!isFinite(videoInfo.avid)||!isFinite(videoInfo.page)?videoInfo.valid=!1:videoInfo.valid=!0);videoInfo.valid?history.replaceState(videoInfo,"av"+videoInfo.avid+"p"+videoInfo.page+" - "+title,"/"+videoInfo.avid+"/"+videoInfo.page):history.replaceState(videoInfo,title,"/"),window.addEventListener("popstate",function(e){videoInfo=e.state,document.title=videoInfo.loaded?document.title=videoInfo.title+" - av"+videoInfo.avid+"p"+videoInfo.page+" - "+title:title,loadVideoInfo()}),$(document).ready(function(){videoInfo.valid&&loadVideoInfo(),$("#uri").on("paste",checkURI).keyup("paste",checkURI)});