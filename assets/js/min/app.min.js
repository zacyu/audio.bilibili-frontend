function generateUUID(){var e=(new Date).getTime();window.performance&&"function"==typeof window.performance.now&&(e+=window.performance.now());var o="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(o){var i=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"===o?i:3&i|8).toString(16)});return o}function showQueryPage(){ajaxBusy=!1,window.currentTask=!1,$(".sweet-alert").is(".visible")&&window.swal.close(),videoInfo={valid:!1},history.state&&history.state.valid?history.pushState(videoInfo,title,"/"):history.replaceState(videoInfo,title,"/"),document.title=title,$("#query").removeClass("hidden"),$("#video-info").addClass("hidden"),$("#loading-holder").addClass("hidden");var e=$("#uri").val("").focus().closest(".mdl-textfield").get(0).MaterialTextfield;e&&e.boundUpdateClassesHandler()}function getVideoTitle(){if(!videoInfo.loaded)return null;if(videoInfo.list.length>1&&videoInfo.list.length>=videoInfo.page){var e=videoInfo.title+"("+videoInfo.page+")";return videoInfo.list[videoInfo.page-1].part.length&&(e+=" - "+videoInfo.list[videoInfo.page-1].part),e}return videoInfo.title}function loadVideoInfoErrorHandler(e){ajaxBusy=!1,window.swal({title:"视频信息读取失败",text:"错误信息: "+e,type:"error",showCancelButton:!0,confirmButtonText:"返回",cancelButtonText:"重试"},function(e){e?history.length>2?history.back():showQueryPage():loadVideoInfo()})}function setPageState(){var e=getVideoTitle(),o=e?e+" - av"+videoInfo.avid+"p"+videoInfo.page+" - "+title:"av"+videoInfo.avid+"p"+videoInfo.page+" - "+title;history.state&&history.state.avid===videoInfo.avid&&history.state.page===videoInfo.page?history.replaceState(videoInfo,o,"/"+videoInfo.avid+"/"+videoInfo.page):history.pushState(videoInfo,o,"/"+videoInfo.avid+"/"+videoInfo.page),document.title=o,e&&renderVideoPage()}function loadVideoInfo(){if(ajaxBusy)return!1;window.currentTask=!1,$(".sweet-alert").is(".visible")&&window.swal.close(),setPageState();var e=localStorage.getItem(videoInfo.avid+"/"+videoInfo.page);if(e)try{e=JSON.parse(window.LZString.decompress(e)),parseInt((new Date).getTime()/1e3)-e.ts<86400&&(videoInfo=e)}catch(o){window.console.error("Failed to read cache.",o),localStorage.removeItem(videoInfo.avid+"/"+videoInfo.page)}return videoInfo.loaded?(setPageState(),!1):(ajaxBusy=!0,$("#query").addClass("hidden"),$("#video-info").addClass("hidden"),$("#loading-holder").removeClass("hidden"),void $.getJSON("http://api.bilibili.com/view?type=jsonp&appkey=95acd7f6cc3392f3&id="+videoInfo.avid+"&page="+videoInfo.page+"&batch=true&callback=?",function(e){return ajaxBusy?(ajaxBusy=!1,void(e.error?loadVideoInfoErrorHandler(e.code+" ("+e.error+")"):(videoInfo=$.extend(videoInfo,{title:e.title,desc:e.description,cover:e.pic,type:e.typename,tags:e.tag.split(","),list:e.list,author:e.author,date:e.created_at,play:e.play,favorites:e.favorites,loaded:!0}),localStorage.setItem(videoInfo.avid+"/"+videoInfo.page,window.LZString.compress(JSON.stringify($.extend(videoInfo,{ts:parseInt((new Date).getTime()/1e3)})))),setPageState()))):!1}).error(function(e){loadVideoInfoErrorHandler(e.status+" ("+e.statusText+")")}))}function checkURI(){if($("#uri").val().length&&$("#uri").get(0).validity.valid){var e=/\/video\/av([0-9]+)\/(index_([0-9]+)\.html)?(\?.*)?$/.exec($("#uri").val());videoInfo={avid:parseInt(e[1]),page:parseInt(e[3])},videoInfo.page=videoInfo.page>0&&isFinite(videoInfo.page)?videoInfo.page:1,videoInfo.valid=!0,loadVideoInfo()}}function renderAudioBlock(e){return e!==window.currentTask?!1:(window.currentTask=!1,void console.log(videoInfo.audio))}function loadAudioInfo(e){if(e!==window.currentTask)return!1;var o=videoInfo.avid,i=videoInfo.page;return videoInfo.audio?(renderAudioBlock(e),!1):void $.ajax("http://bilibili.audio/get.php",{method:"GET",dataType:"json",timeout:5e3,data:{aid:o,p:i}}).done(function(t){switch($("#audio-info .center .mdl-progress").removeClass("mdl-progress__indeterminate"),$("#audio-info .center .mdl-progress").get(0).MaterialProgress.setProgress(0),$("#audio-info .center .mdl-progress").addClass("mdl-progress__indeterminate"),$("#audio-info .center p").text("根据服务器负载, 这可能需要一段时间..."),parseInt(t.process)){case 1:$("#audio-info .center h3").text("正在解析视频信息");break;case 2:$("#audio-info .center h3").text("正在获取视频信息");break;case 3:t.progress=t.progress?parseFloat(t.progress):0,t.progress>100&&(t.progress=100),$("#audio-info .center h3").text("正在下载视频文件"),$("#audio-info .center p").text("音频格式: "+t.format+" ("+t.quality+" kbit/s) 当前进度: "+t.progress+"%"),$("#audio-info .center .mdl-progress").removeClass("mdl-progress__indeterminate"),$("#audio-info .center .mdl-progress").get(0).MaterialProgress.setProgress(t.progress);break;case 4:$("#audio-info .center h3").text("正在保存音频文件"),$("#audio-info .center p").text("音频格式: "+t.format+" ("+t.quality+" kbit/s)");break;case 5:if(parseInt(t.status)){videoInfo.audio=t,localStorage.setItem(videoInfo.avid+"/"+videoInfo.page,window.LZString.compress(JSON.stringify(videoInfo))),renderAudioBlock(e);break}$("#audio-info .center h3").text("发生异常错误");break;default:window.console.error("Failed to get audio info for task "+window.currentTask+" (av"+o+"p"+i+")!"),window.setTimeout(function(){loadAudioInfo(e)},1e3)}var n=function(){return e!==window.currentTask?!1:void window.swal({title:"音频文件提取/转换失败",text:"点击「重试」重新提交任务",type:"error",showCancelButton:!0,confirmButtonText:"重试",cancelButtonText:"取消"},function(t){return t?void $.ajax("http://bilibili.audio/get.php?aid="+o+"&p="+i,{method:"POST",dataType:"json",timeout:1e3,data:{retry:1}}).always(function(){loadAudioInfo(e)}):!1})},a=function(){return d&&e===window.currentTask?(window.swal({title:"音频文件提取/转换失败",text:"请等待 "+(120+parseInt(t.time)-parseInt((new Date).getTime()/1e3))+" 秒后重试...",type:"error",showCancelButton:!0,showConfirmButton:!1,cancelButtonText:"取消"},function(){d=!1}),void(parseInt((new Date).getTime()/1e3)-parseInt(t.time)<=120?setTimeout(function(){a()},1e3):n())):!1},d=!1;0===parseInt(t.status)&&(parseInt(t.process)<3||5===parseInt(t.process)||10===parseInt(t.retry))?parseInt((new Date).getTime()/1e3)-parseInt(t.time)>120?n():(d=!0,a()):5!==parseInt(t.status)&&setTimeout(function(){loadAudioInfo(e)},500)}).error(function(o,i){"timeout"===i?loadAudioInfo(e):window.setTimeout(function(){loadAudioInfo(e)},1e3)})}function renderVideoPage(){$("#video-info").removeClass("hidden"),$("#query").addClass("hidden"),$("#loading-holder").addClass("hidden"),$("#video-info .cover").css("background-image","url("+videoInfo.cover+")"),$("#video-info .title").text(getVideoTitle()),$("#video-info .author").text(videoInfo.author),$("#video-info .type").text(videoInfo.type),$("#video-info .date").text(videoInfo.date),$("#video-info .play").text(videoInfo.play),$("#video-info .favorites").text(videoInfo.favorites),$("#video-info .desc").text(videoInfo.desc),$("#video-info .tags").empty();for(var e in videoInfo.tags)$("#video-info .tags").append($('<span class="tag">').text(videoInfo.tags[e]).prop("outerHTML")+" ");if($("#part-dropdown .mdl-menu__container").remove(),videoInfo.list.length>1){$("#part-dropdown").show();var o=$('<ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="part-btn"></ul>'),i=function(){$(this).data("page")!==videoInfo.page&&(videoInfo={avid:videoInfo.avid,page:$(this).data("page"),valid:!0},loadVideoInfo())};for(var e in videoInfo.list){var t=parseInt(e)+1+"、"+(videoInfo.list[e].part.length?videoInfo.list[e].part:"分段"+(parseInt(e)+1)),n=$('<li class="mdl-menu__item"></li>').text(t).click(i).data("page",parseInt(e)+1);parseInt(e)+1===videoInfo.page&&n.attr("disabled",!0),o.append(n)}$("#part-dropdown").append(o),window.componentHandler.upgradeElements(o.toArray())}else $("#part-dropdown").hide();videoInfo.ts?$("#refresh-btn").show():$("#refresh-btn").hide(),window.currentTask=generateUUID(),loadAudioInfo(window.currentTask),$("#audio-info .center .mdl-progress").removeClass("mdl-progress__indeterminate"),$("#audio-info .center .mdl-progress").get(0).MaterialProgress.setProgress(0),$("#audio-info .center .mdl-progress").addClass("mdl-progress__indeterminate"),$("#audio-info .center h3").text("正在提交任务"),$("#audio-info .center p").text("根据服务器负载, 这可能需要一段时间...")}var title="哔哩哔哩音频 - bilibili.audio",videoInfo={},ajaxBusy=!1;if(videoInfo.param=location.pathname.slice(1).split("/"),/^\/video\/av([0-9]+)\/(index_([0-9]+)\.html)?(\?.*)?$/.test(location.pathname)){var matches=/^\/video\/av([0-9]+)\/(index_([0-9]+)\.html)?(\?.*)?$/.exec(location.pathname);videoInfo.avid=parseInt(matches[1]),videoInfo.page=parseInt(matches[3]),videoInfo.page=videoInfo.page>0&&isFinite(videoInfo.page)?videoInfo.page:1,videoInfo.valid=!0}else 2!==videoInfo.param.length?videoInfo.valid=!1:(videoInfo.avid=parseInt(videoInfo.param[0]),videoInfo.page=parseInt(videoInfo.param[1]),isNaN(videoInfo.avid)||isNaN(videoInfo.page)||!isFinite(videoInfo.avid)||!isFinite(videoInfo.page)?videoInfo.valid=!1:videoInfo.valid=!0);window.addEventListener("popstate",function(e){videoInfo=e.state,document.title=videoInfo.loaded?document.title=getVideoTitle()+" - av"+videoInfo.avid+"p"+videoInfo.page+" - "+title:title,videoInfo.valid?loadVideoInfo():showQueryPage()}),$(document).ready(function(){videoInfo.valid?loadVideoInfo():showQueryPage(),$("#uri").on("paste",checkURI).keyup("paste",checkURI),$(".mdl-layout-title").click(function(){showQueryPage()}),$("#video-info .cover .play_hover i").click(function(){window.open("http://www.bilibili.com/av"+videoInfo.avid+"/index_"+videoInfo.page+".html")}),$("#refresh-btn").click(function(){return videoInfo.valid?(localStorage.removeItem(videoInfo.avid+"/"+videoInfo.page),videoInfo={avid:videoInfo.avid,page:videoInfo.page,valid:!0},void loadVideoInfo()):!1})});